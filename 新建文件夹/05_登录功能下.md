## 四、跨域的处理以及登录功能上


1.解决数据请求的跨域问题
a. 在carsever下新建config软件包
b. 创建一个类CorsConfig
```
//解决跨域
@Configuration
public class CorsConfig implements WebMvcConfigurer {



    @Override
    public void addCorsMappings(CorsRegistry registry) {
        registry.addMapping("/**")
                .allowedOriginPatterns("*")
                .allowedMethods("*")
                .allowedHeaders("*")
                .allowCredentials(true)
                .maxAge(3600);
    }
}
```


2.修改用户的登录功能的前端文件
a. 打开登录页面的jsx文件,查看axios请求
b. 将请求地址改为`/users/login`



c. 打开json-server查看之前数据的格式




d. 在Users类中新增属性Roles
```
@Data
@EqualsAndHashCode(callSuper = false)
public class Users implements Serializable {

    private static final long serialVersionUID = 1L;

    @TableId(value = "id", type = IdType.AUTO)
    private Integer id;

    private String username;

    private String password;
    @TableField("roleId")
    private Integer roleId;

    private String name;

    private String phone;

    private Integer block;


    @TableField(exist = false)
    private Roles role;
    
}

```

e. 数据库新增四个表格,分别对应四个不同的角色,运行sql中的roles文件
    



f. 根据表格创建一个新的Role_right类,并按这个类创建Dao文件,对应的xml文件,Service文件,Impl文件
```
/**--------------pojo-----------------**/
@Data
@EqualsAndHashCode(callSuper = false)
public class Role_right implements Serializable {

    private static final long serialVersionUID = 1L;

    @TableId(value = "id", type = IdType.ASSIGN_ID)
    private Integer id;

    private String label;

    private String key;

    private Integer grade;

    private Integer pagepermission;

    private Integer rightId;

    private Integer routepermission;

    @TableField(exist = false)
    @TableLogic(value = "0",delval = "1")    //逻辑删除字段
    private Integer deleted;

}

/**--------------Dao-----------------**/

@Mapper
public interface Roles_RightDao extends BaseMapper<Role_right> {


    @Select("SELECT r0.key FROM role_0 r0  ")
    List<String> GetRole_0();

    @Select("SELECT r1.key FROM role_1 r1 WHERE deleted = 0")
    List<String> GetRole_1();

    @Select("SELECT r2.key FROM role_2 r2 WHERE deleted = 0")
    List<String> GetRole_2();

    @Select("SELECT r3.key FROM role_3 r3 WHERE deleted = 0")
    List<String> GetRole_3();
}


/**--------------xml-----------------**/

<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.carsever.dao.Roles_RightDao">

</mapper>


/**--------------Service-----------------**/





/**--------------Impl-----------------**/





```


g. 根据请求的地址和请求方式在UsersController中
```
@RestController
@RequestMapping("/users")
public class UsersController {

    @Autowired
    private IUsersService usersService;
    @Autowired
    private IRoles_RightDaoService roles_rightDaoService;

    //登陆
    @PostMapping("/login")
    public WebResult loginIn(@RequestBody Users users) {
        //查询数据库数据
        List list = usersService.lambdaQuery()
                .eq(Users::getUsername, users.getUsername())
                .eq(Users::getPassword, users.getPassword()).list();
        if (list.size() < 1) return WebResult.fail("用户名或密码错误");
        if (list.size() > 1) return WebResult.fail("用户出现异常,请稍后登录");
        Users u = (Users) list.get(0);

        //System.out.println(roles_rightDaoService.GetRoleByNumber(u.getRoleId()));
        u.setRights(roles_rightDaoService.GetRoleByNumber(u.getRoleId()));

        return WebResult.success(u);

    }
}

```